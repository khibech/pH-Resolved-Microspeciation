#LINUX and GROMACS UNIVERSAL TUTORIAL

----INSTALL UBUNTU-----
UPGRADE AND UPDATE LIBRARIES OF UBUNTU BY FOLLOWING COMMANDS

Commands:
sudo apt update
sudo apt upgrade
sudo apt install gcc
sudo apt install cmake
sudo apt install build-essential
sudo apt install libfftw3-dev OR
sudo apt-get install -y libfftw3-dev

ONCE THE ABOVE COMMANDS ARE INTERED AND LINUX SYSTEM IS UPDATED, PROCEED TO INSTALL GROMACS

---------------GROMACS DIRTY INSTALLATION COMMAND--------------
sudo apt install gromacs
sudo apt remove gromacs
--------------------Install Pymol------------------------
sudo apt-get install -y pymol

--------------Install google chrome----------------------
get https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
sudo apt install ./google-chrome-stable_current_amd64.deb

-----------------Install Chimera------------------------
Download the set-up file from "https://www.cgl.ucsf.edu/chimera/download.html"
Move the file to desired folder.
In tht folder open terminal
Command:
ls (to check the name of setup file)
chmod +x CHIMERA-INSTALLER.bin
./CHIMERA-INSTALLER.bin
 
-----------------Autodoc-Vinna------------------------
Go to download page "http://vina.scripps.edu/download.html"
Move the file to desired folder.
In that folder open terminal
Command:
ls (to check the name of setup file)
tar -xzvf autodock_vina_1_1_2_linux_x86.tgz

-------------------Install-GRACE----------------------
sudo apt-get install grace  

------------------------VMD---------------------------
https://www.ks.uiuc.edu/Development/Download/download.cgi?PackageName=VMD
1. Save the .tar.gz file in working folder
2. open the extracted folder and run command './configure' by opening the termianl  
3. Open the folder src in terminal and run the command 'sudo make install' 
4. type 'vmd' in termial and program should run. 

###################MANNUAL-GROMACS-COMPILATION###########################
#	Download Gromacs from : 					#
#	https://manual.gromacs.org/current/download.html#		#
#									#
###################################CUDA TOOLKIT:######################### 
#	https://developer.nvidia.com/cuda-downloads			#
#	#Follow the steps and copy the commands				#
#									#
#########################Gromacs Compilation Process#####################
#	tar xfz gromacs-2020.2.tar.gz					#
#	cd gromacs-2020.2						#
#	mkdir build							#
#	cd build							#
#	cmake .. -DGMX_GPU=CUDA -DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda	#
#	make								#
#	make check							#
#	sudo make install						#
#	source /usr/local/gromacs/bin/GMXRC				#
#########################################################################


#########STEPS FOR MD AS FOLLOWS######### 

---PREPARE LIGAND AND RECEPTOR IN CHIMERA----
1. open the best pose ligand with the receptor Protein.pdb file
2. Delete the chain of protein, in the residual ligand, add hydrogens and save it as LIG.mol2 as 'LIG.mol2'

#Open the LIG.mol2 file and in the second line 
#Correction to be made in LIG.mol2 
#Open LIG.mol2 by using gedit command or simplyopening file in any text editor.
2.1.	"@<TRIPOS>MOLECULE" make sure this is the first line in file
	delete the header and empty space if you have to
	
2.2.      "@<TRIPOS>MOLECULE” there will be name after this line maybe xxx.pdb or ****** or anything else
	change it to LIG 
	
2.3.	bond orders "@<TRIPOS>BOND" will be arranged differently in each file 
arrange them in specific order to avoid errors use 
perl sort_mol2_bonds.pl LIG.mol2 LIG.mol2 script

3. Go to SwissParam "http://www.swissparam.ch/" and upload the 'Lig.mol2 file'
4. Download the .zip folder
5. Again open the best pose ligand with the receptor .pdb file, delete ligand, Perform DockPrep of protein as save it as .pdb file as 'REC.pdb'
6. Make a working Folder for Gromacs, copy contents of the downloaded zip file into this folder, copy the DockPrep 'rec.pdb' in to working folder
7. Copy all the .mdp files into this working folder
8. Open the terminal in this working folder and proceed with Gromacs.  

---------GROMACS UBUNTU TUTORIAL-----------
source /usr/local/gromacs/bin/GMXRC	(If Gromacs is manually compiled / not for dirty install)  

gmx pdb2gmx -f REC.pdb -ignh
8 (CHARMM27)
1 (TIP3P)
gmx editconf -f LIG.pdb -o LIG.gro
gedit conf.gro LIG.gro
sed -i 's/UNK/LIG/g' conf.gro
sed -i 's/UNK/LIG/g' LIG.itp
*(Copy content from 3rd line of lig.gro to the conf.gro file up to the 2nd last line)
*(Check the column number from where the lig.gro data ends (x) in conf.gro and replace the value in 2nd line by x-3)
*(Open file in chimera to check ligand and receptor)

-----EDIT THE FOLLOWING in topol.top -----
gedit topol.top
(add 

; Include ligand topology 
#include "LIG.itp"

below- Include forcefield parameters
#include "amberGS.ff/forcefield.itp")

AT THE BOTTOM OF THE SAME FILE PERFORM FOLLOWING CHANGES
(add LIG 1
align exactly below-
Protein_chain_E     1)

-----EDIT THE FOLLOWING in lig.itp -----

gedit LIG.itp
[ moleculetype ]
; Name nrexcl
lig_gmx2 3
TO
[ moleculetype ]
; Name nrexcl
LIG 3
(in certain cases this will already be LIG 3 so for such case no change is needed)

----------

gmx editconf -f conf.gro -d 1.0 -bt triclinic -o box.gro

gmx solvate -cp box.gro -cs spc216.gro -p topol.top -o box_sol.gro

gmx grompp -f ions.mdp -c box_sol.gro -p topol.top -o ION.tpr      
(OR)
gmx grompp -f ions.mdp -c box_sol.gro -maxwarn 2 -p topol.top -o ION.tpr


gmx genion -s ION.tpr -p topol.top -conc 0.1 -neutral -o box_sol_ion.gro
15

gmx grompp -f EM.mdp -c box_sol_ion.gro -p topol.top -o EM.tpr     (OR)
gmx grompp -f EM.mdp -c box_sol_ion.gro -maxwarn 2 -p topol.top -o EM.tpr

gmx mdrun -v -deffnm EM

gedit nvt.mdp (This file is already modified)

Now make index files
 
gmx make_ndx -f LIG.gro -o index_LIG.ndx
	 > 0 & ! a H*
 	 > q

gmx genrestr -f LIG.gro -n index_LIG.ndx -o posre_LIG.itp -fc 1000 1000 1000
	> select group "3"
	
Now, open gedit topol.top file

	at the end of the document 

	after 
		"; Include Position restraint file
		#ifdef POSRES
		#include "posre.itp"
		#endif

		"Here"

	add this 

		; Ligand position restraints
		#ifdef POSRES
		#include "posre_LIG.itp"
		#endif

Again, Make other Index file for System 

gmx make_ndx -f EM.gro -o index.ndx
	
	> 1 | 13
	name 24 Protein_LIG
	> q
	
-----[NVT]-----
gedit NVT.mdp (This file is already modified)

gmx grompp -f NVT.mdp -c EM.gro -r EM.gro -p topol.top -n index.ndx -maxwarn 2 -o NVT.tpr
	
gmx mdrun -deffnm NVT


-----[NPT]-----
gedit NPT.mdp (This file is already modified)

gmx grompp -f NPT.mdp -c NVT.gro -r NVT.gro -p topol.top -n index.ndx -maxwarn 2 -o NPT.tpr
	
gmx mdrun -deffnm NPT

-----[FINAL MD RUN/PRODUCTION]-----
gedit MD.mdp (Change MD RUN TIME as per your need)

gmx grompp -f MD.mdp -c NPT.gro -t NPT.cpt -p topol.top -n index.ndx -maxwarn 2 -o MD.tpr

gmx mdrun -deffnm MD


----[Recentering and Rewrapping Coordinates]----
gmx trjconv -s MD.tpr -f MD.xtc -o MD_center.xtc -center -pbc mol -ur compact
1
0
#Choose "Protein" for centering and "System" for output.

#To extract the first frame (t = 0 ns) of the trajectory, use trjconv -dump with the recentered trajectory:
gmx trjconv -s MD.tpr -f MD_center.xtc -o start.pdb -dump 0


------RMSD Calculations-----
gmx rms -s MD.tpr -f MD_center.xtc -o rmsd.xvg
gmx rms -s MD.tpr -f MD_center.xtc -o rmsd.xvg -tu ns
4
13


#(Select appropritate 2 options one by one and then open the output files in Grace) Select Backbone and then LIG

xmgrace rmsd.xvg rmsd1.xvg

------RMSF Calculations-----
gmx rmsf -s MD.tpr -f MD_center.xtc -o rmsf.xvg
4

(Select appropritate Backbone open the output files in Grace)

xmgrace rmsf.xvg rmsf1.xvg

-----------h-bonds-------------------
gmx hbond -s MD.tpr -f MD_center.xtc -num hb.xvg
gmx hbond -s MD.tpr -f MD_center.xtc -num hb.xvg -tu ns
1
13
xmgrace hb.xvg

--------------Gyration Radius------------------
gmx gyrate -s MD.tpr -f MD_center.xtc -o gyrate1.xvg
#Choose the group of your choice 
xmgrace gyrate1.xvg

-------------ENERGY Calculations---------------
gmx energy -f MD.edr -o energy1.xvg
#Choose the option of your choice
xmgrace -nxy energy1.xvg

/home/oussama/Bureau/gromacs-2021.3/build/bin/gmx
export PATH=/home/oussama/Bureau/gromacs-2021.3/build/bin:$PATH
gmx --version


conda info --envs

conda activate AmberTools23



acpype -i LIG.mol2

acpype -i LIG.mol2 -c user -n 1

netwaye le protein : 

# Active AmberTools23 si ce n’est pas fait
conda activate AmberTools23

# Crée le fichier leap.in automatiquement :
cat > leap.in << EOF
source leaprc.protein.ff14SB
source leaprc.water.spce
prot = loadPdb R.pdb
savePdb prot REC.pdb
quit
EOF

# Lance tleap
tleap -f leap.in

autre methode si donne ****
  grep -v "ATOM.*\*\*\*\*" REC.pdb > REC_clean.pdb
  
  
  


conda activate gmxmmpbsa

gmx make_ndx -f MD.tpr -o GBSA.ndx

name 1 Receptor        ; 
name 13 Ligand         ; 
1 | 13         
name 24 Complex        ; 
             
q  

source $CONDA_PREFIX/amber.sh

### 1) تجهيز المسار (trjconv) بخيوط OpenMP
export OMP_NUM_THREADS=4        


gmx trjconv -s MD.tpr -f MD_60-100ns.xtc \
            -o MD_fit.xtc -pbc mol -center -ur compact \
            -n GBSA.ndx
            
            
mpirun -np 4 gmx_MMPBSA -O \
       -i  mmpbsa.in  \
       -cs MD.tpr     \
       -ct MD_fit.xtc \
       -ci index.ndx   -cg 1 13 \
       -cp topol.top \
       -o  FINAL_RESULTS_4CPU.dat \
       -eo FINAL_DECOMP_4CPU.dat
           
           grep -l '\*\*\*\*\*\*\*' _GMXMMPBSA_*_gb.mdout.* > bad.list
           gmx check -f MD_60-100ns.xtc | grep "Step"
  
nano mpbsa.in

&general
   startframe = 1,     endframe = 100,     interval = 1,
   verbose     = 1,    keep_files = 0,
/
&gb
   igb = 5,     saltcon = 0.15,
/
&decomp
   idecomp = 1,
/



grep -A2 "DELTA G binding" FINAL_RESULTS.dat


gmx_MMPBSA -deo FINAL_ENERGIES.dat -O      # déjà généré si &general verbose=1





gmx_MMPBSA_ana

energie  gmx_MMPBSA_ana -f FINAL_RESULTS.dat



sed -e 's/ 0\.0  / LIG  /' LIG.gro > LIG_fixed.gro
sed -e 's/\(^ *[0-9]\+ \+[^ ]\+ \+1 \+\)0\.0/\1LIG/' LIG.itp > LIG_fix.itp



PCA 

gmx covar  -s MD.tpr  -f MD_fit.xtc   -n index.ndx \
           -o eigenval.xvg  -v eigenvec.trr  -av average.pdb
           3
           3
           
    


xmgrace eigenval.xvg

gmx anaeig -v eigenvec.trr -s MD.tpr -f MD_fit.xtc \
           -first 1 -last 2 \
           -2d 2Dproj_PC1_PC2.xvg
           
python 2D.py
python 3D.py
       
     
     
convert fel.eps fel.png
    
   

